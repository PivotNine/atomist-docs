Change the code through commands. Code transforms allow you to issue commands that edit code, be it by adding new code or changing existing code. Transforms can be run on one or more repositories.

## Creating a code transform

Code transforms are functions that receive the project as an input and changes the content of the project as a result. Assume we want to add an Apache licence file to the project. The transform would retrieve the license content and add a `LICENSE` file with that content.

``` typescript
export const AddApacheLicenseFileTransform: CodeTransform<NoParameters> = async p => {
    const httpClient = DefaultHttpClientFactory.create();
    const license = await httpClient.exchange("https://www.apache.org/licenses/LICENSE-2.0.txt");
    return p.addFile("LICENSE", license.body as string);
};
 ```           
## Creating a command for a transform

A code transform can be called through various means. One of those means is directly through issuing a command. This command needs to be defined and the transform needs to be referenced in that definition.

``` typescript
export const AddApacheLicenseFile: CodeTransformRegistration<NoParameters> = {
    transform: AddApacheLicenseFileTransform,
    name: "add apache license file",
    description: `Add Apache 2.0 license file`,
    intent: ["add apache license file", "add license file"],
};
```

As you can see here, you can define multiple intents that will act as aliases for invoking the command.

## Adding the transform command to the SDM

The SDM needs to be made aware of the existence of the command. In order to achieve this you need to register the command with the SDM. In your SDM definition where you have access to the SDM instance, add the following registration:

``` typescript
sdm.addCodeTransformCommand(AddApacheLicenseFile);
```

## Calling the command

Once the command has been registered, you can issue the command through one of the intents in a channel that is linked to a repository.

```
@atomist add apache license file
```

Atomist will create a branch and apply the code transform on that branch. It will also create a pull request for the commits generated by that branch. By default, the name of the pull request will be the description of the code transform.

## Adding parameters to the code transform command

Sometimes you need additional input after issuing the command to transform a certain piece of code. Say that we wish to make the license file transformation a bit more flexible and allow of different types of licences. First we need to define the data structure that will hold the parameters.

``` typescript
@Parameters()
class AddApacheLicenseFileParameters {
    @Parameter({
        displayName: "License type",
        validInput: "apache20, gpl, lgpl",
        pattern: /(apache20|gpl|lgpl)/,
        required: false,
    })
    public license: "apache20"|"gpl"|"lgpl" = "apache20";
}
```

Next we need to make the transform aware of the new parameters and alter the internal logic in order to take those parameters into account.

``` typescript
export const AddApacheLicenseFileTransform: CodeTransform<AddApacheLicenseFileParameters> = async (p, params) => {
    const licenses = {
        apache20: "https://www.apache.org/licenses/LICENSE-2.0.txt",
        gpl: "https://www.gnu.org/licenses/gpl-2.0.txt",
        lgpl: "https://www.gnu.org/licenses/lgpl-3.0.txt",
    };

    const httpClient = DefaultHttpClientFactory.create();
    const license = await httpClient.exchange(licenses[params.parameters.license]);
    return p.addFile("LICENSE", license.body as string);
};
```     

Finally, we need to alter the command registration so that it recognizes the command parameters and prompt for their values if they are required.

``` typescript
export const AddApacheLicenseFile: CodeTransformRegistration<AddApacheLicenseFileParameters> = {
    transform: AddApacheLicenseFileTransform,
    paramsMaker: AddApacheLicenseFileParameters,
    name: "add apache license file",
    description: `Add Apache 2.0 license file`,
    intent: ["add apache license file", "add license file"],
};
```

When issuing the command, it will prompt for the parameters values that are required. You can still issue the values for non-required parameters like this:

```
@atomist add apache license file license=gpl
```
 
## Changing the branch and generated pull request

If you want, you can alter the contents of the pull request by defining a `transformPresentation` on the code transform. 

```
export const AddApacheLicenseFile: CodeTransformRegistration<AddApacheLicenseFileParameters> = {
    transform: AddApacheLicenseFileTransform,
    paramsMaker: AddApacheLicenseFileParameters,
    name: "add apache license file",
    description: `Add Apache 2.0 license file`,
    intent: ["add apache license file", "add license file"],
    transformPresentation: () => new editModes.PullRequest("license-file", "Add license file"),
};
```

This will cause the transform to be run on the `license-file` branch and the resulting pull request have `Add license file` as a title. 

## Defer pull request creation based on build outcome

Atomist will automatically create a pull request when executing a code transform. However, the goal set execution can still fail. To mitigate unneeded unstable pull request creation, you can wrap your code transform registration in the `makeBuildAware` function.

``` typescript
export const AddApacheLicenseFile: CodeTransformRegistration<AddApacheLicenseFileParameters> = makeBuildAware({
    transform: AddApacheLicenseFileTransform,
    paramsMaker: AddApacheLicenseFileParameters,
    name: "add apache license file",
    description: `Add Apache 2.0 license file`,
    intent: ["add apache license file", "add license file"],
});
```   

## Enabling auto merge of pull request based on build outcome

By default, you still need to manually merge the pull request. You can however configure code transforms to auto merge on a successful goalset execution. You can achieve this by pressing the `Enable Auto Merge` button that is shown in Slack in the pull request message. This will add a certain label (`auto-merge:on-check-success`) to the pull request, which indicates to Atomist that the pull request needs to be merged on a succesful goalset execution. You can also add that label manually in Github if you want to.

!!! atttention "Adding labels to Github"
    If the labels are missing in Github, issue the `@atomist add auto merge labels` command in the channel linked to a repository
    
## Changing merge behavior of pull requests

By default, Atomist will merge a pull request by adding the commits to the target branch using a merge commit. It is however also capable of using different merge strategies, like rebase or squash. In order to do this, you can add different labels to the pull request. The following labels are supported:
* `auto-merge-method:merge`: use a merge commit
* `auto-merge-method:rebase`: rebase the commits onto the target branch
* `auto-merge-method:squash`: squash all the commits into a single commit

In the event of a squash, the commit message of the new commit will be the title of the pull request.

!!! attention "Adding labels to Github"
    If the labels are missing in Github, issue the `@atomist add auto merge labels` command in the channel linked to a repository



